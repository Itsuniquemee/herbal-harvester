<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herbal Harvester</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Herbal Harvester">
    
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans Devanagari', sans-serif;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        .app-screen {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background-color: #f8fafc;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }

        .app-screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        input[type="text"], select {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background-color: #f9fafb;
            width: 100%;
            font-size: 1rem;
        }

        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
    </style>
</head>
<body class="bg-gray-800">
    <!-- Mobile App Container -->
    <div class="max-w-md mx-auto h-[100dvh] bg-gray-50 shadow-2xl overflow-hidden relative">

        <!-- Loading Screen -->
        <div id="loadingScreen" class="app-screen active flex items-center justify-center bg-emerald-700 text-white">
            <div class="text-center">
                <i class="ph-fill ph-leaf text-6xl opacity-50"></i>
                <h1 class="text-3xl font-bold mt-4">Herbal Harvester</h1>
                <p class="text-lg opacity-80 mt-2">Loading...</p>
            </div>
        </div>

        <!-- Home Screen -->
        <div id="homeScreen" class="app-screen p-6 justify-center">
            <h1 class="text-3xl font-bold text-gray-800 text-center mb-8">Herbal Harvester</h1>
            
            <div class="grid grid-cols-2 gap-5">
                <!-- New Collection -->
                <button onclick="initNewCollection()" class="flex flex-col items-center justify-center p-6 bg-emerald-600 text-white rounded-xl shadow-lg h-36 transition-transform active:scale-95">
                    <i class="ph-fill ph-plant text-5xl"></i>
                    <span class="text-lg font-bold mt-2">New Collection</span>
                </button>
                
                <!-- My Collections -->
                <button onclick="showScreen('collectionsScreen')" class="flex flex-col items-center justify-center p-6 bg-blue-600 text-white rounded-xl shadow-lg h-36 transition-transform active:scale-95">
                    <i class="ph-fill ph-archive-box text-5xl"></i>
                    <span class="text-lg font-bold mt-2">My Collections</span>
                </button>
                
                <!-- Sync Data -->
                <button onclick="triggerSync()" class="flex flex-col items-center justify-center p-6 bg-gray-700 text-white rounded-xl shadow-lg h-36 transition-transform active:scale-95">
                    <i class="ph-fill ph-cloud-arrow-up text-5xl"></i>
                    <span class="text-lg font-bold mt-2">Sync Data</span>
                </button>
                
                <!-- Settings -->
                <button onclick="showScreen('settingsScreen')" class="flex flex-col items-center justify-center p-6 bg-gray-400 text-gray-800 rounded-xl shadow-lg h-36 transition-transform active:scale-95">
                    <i class="ph-fill ph-gear text-5xl"></i>
                    <span class="text-lg font-bold mt-2">Settings</span>
                </button>
            </div>

            <div id="syncStatusFooter" class="text-center text-gray-500 mt-8">
                Ready to collect herbs!
            </div>
        </div>

        <!-- New Collection Screen -->
        <div id="newCollectionScreen" class="app-screen">
            <header class="flex-shrink-0 flex items-center p-4 border-b bg-white">
                <button onclick="showScreen('homeScreen')" class="p-2 rounded-full hover:bg-gray-100">
                    <i class="ph ph-arrow-left text-2xl text-gray-700"></i>
                </button>
                <h1 class="text-xl font-bold text-gray-800 ml-4">New Collection</h1>
            </header>
            
            <div class="flex-1 p-4 space-y-4 overflow-y-auto">
                <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg">
                    <h2 class="font-bold text-emerald-800 mb-3">Automatic Data</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">üìç GPS Coordinates</label>
                            <input type="text" id="gpsInput" placeholder="Click camera to get location" disabled>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">üïí Time & Date</label>
                            <input type="text" id="timestampInput" placeholder="Click camera to get time" disabled>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-white border border-gray-200 rounded-lg">
                    <h2 class="font-bold text-gray-800 mb-3">Collection Details</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="speciesInput" class="block text-sm font-medium text-gray-700 mb-1">üåø Herb Name</label>
                            <select id="speciesInput">
                                <option value="">Select Species</option>
                                <option value="Ashwagandha">Ashwagandha</option>
                                <option value="Tulsi">Tulsi (Holy Basil)</option>
                                <option value="Brahmi">Brahmi</option>
                                <option value="Amla">Amla</option>
                                <option value="Neem">Neem</option>
                                <option value="Guduchi">Guduchi (Giloy)</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="weatherInput" class="block text-sm font-medium text-gray-700 mb-1">üå¶Ô∏è Weather (Optional)</label>
                            <select id="weatherInput">
                                <option value="">Select Condition</option>
                                <option value="Sunny">Sunny</option>
                                <option value="Cloudy">Cloudy</option>
                                <option value="Rainy">Rainy</option>
                                <option value="Humid">Humid</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">üì∑ Photo Evidence</label>
                            <button onclick="startCamera()" class="w-full p-3 bg-blue-600 text-white rounded-lg font-semibold flex items-center justify-center shadow hover:bg-blue-700 active:bg-blue-800">
                                <i class="ph ph-camera text-xl mr-2"></i>
                                <span>Open Camera to Add Photo</span>
                            </button>
                            <input type="hidden" id="photoBase64Input">
                            <img id="photoPreview" src="" alt="Photo preview" class="hidden mt-4 rounded-lg border border-gray-300 w-full object-cover max-h-64">
                        </div>
                    </div>
                </div>
            </div>
            
            <footer class="flex-shrink-0 p-4 border-t bg-white">
                <button onclick="saveCollection()" class="w-full bg-emerald-600 text-white p-4 rounded-lg font-bold text-lg flex items-center justify-center shadow-lg hover:bg-emerald-700 active:bg-emerald-800">
                    <i class="ph ph-download-simple text-2xl mr-2"></i>
                    <span>Save Collection</span>
                </button>
            </footer>
        </div>

        <!-- My Collections Screen -->
        <div id="collectionsScreen" class="app-screen">
            <header class="flex-shrink-0 flex items-center p-4 border-b bg-white">
                <button onclick="showScreen('homeScreen')" class="p-2 rounded-full hover:bg-gray-100">
                    <i class="ph ph-arrow-left text-2xl text-gray-700"></i>
                </button>
                <h1 class="text-xl font-bold text-gray-800 ml-4">My Collections</h1>
            </header>
            
            <div id="collectionListContainer" class="flex-1 overflow-y-auto bg-white p-4">
                <p class="text-center text-gray-500 py-8">No collections yet. Start by creating your first collection!</p>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="app-screen flex flex-col">
            <div class="p-6 text-center">
                <div class="mb-8">
                    <i class="ph-fill ph-plant text-6xl text-emerald-600 mb-4 block"></i>
                    <h1 class="text-2xl font-bold text-gray-800">Herbal Harvester</h1>
                    <p class="text-gray-600 mt-2">Digital collection tracking for rural farmers</p>
                </div>

                <form id="loginForm" class="space-y-4">
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Collector ID</label>
                        <input type="text" id="loginUserId" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               placeholder="Enter your collector ID">
                    </div>
                    
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="loginPassword" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               placeholder="Enter your password">
                    </div>

                    <button type="submit" class="w-full bg-emerald-600 text-white p-3 rounded-lg font-bold text-lg shadow-lg hover:bg-emerald-700 active:bg-emerald-800">
                        <i class="ph-fill ph-sign-in mr-2"></i>
                        Login
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <p class="text-gray-600">Don't have an account?</p>
                    <button onclick="screenManager.showScreen('registerScreen')" class="text-emerald-600 font-semibold hover:text-emerald-700">
                        Register here
                    </button>
                </div>

                <div class="mt-8 text-xs text-gray-500">
                    <button onclick="continueWithoutAuth()" class="text-blue-600 underline">
                        Continue without login (offline only)
                    </button>
                </div>
            </div>
        </div>

        <!-- Registration Screen -->
        <div id="registerScreen" class="app-screen flex flex-col">
            <div class="bg-white border-b border-gray-200 px-4 py-3 flex items-center">
                <button onclick="screenManager.showScreen('loginScreen')" class="text-gray-600 hover:text-gray-800">
                    <i class="ph ph-arrow-left text-xl"></i>
                </button>
                <h2 class="ml-3 text-lg font-semibold text-gray-800">Register</h2>
            </div>

            <div class="flex-1 p-4 overflow-y-auto">
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Collector ID</label>
                        <input type="text" id="registerUserId" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               placeholder="Choose a unique ID (e.g., RAM001)">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                        <input type="text" id="registerName" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               placeholder="Enter your full name">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mobile Number</label>
                        <input type="tel" id="registerPhone" required pattern="[6-9][0-9]{9}"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               placeholder="10-digit mobile number">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Village</label>
                        <input type="text" id="registerVillage" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               placeholder="Your village name">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">District</label>
                        <input type="text" id="registerDistrict" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               placeholder="Your district">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                        <input type="text" id="registerState" required 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               placeholder="Your state">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="registerPassword" required minlength="6"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               placeholder="Minimum 6 characters">
                    </div>

                    <button type="submit" class="w-full bg-emerald-600 text-white p-3 rounded-lg font-bold text-lg shadow-lg hover:bg-emerald-700 active:bg-emerald-800">
                        <i class="ph-fill ph-user-plus mr-2"></i>
                        Register
                    </button>
                </form>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="app-screen flex flex-col">
            <div class="bg-white border-b border-gray-200 px-4 py-3 flex items-center">
                <button onclick="screenManager.showScreen('homeScreen')" class="text-gray-600 hover:text-gray-800">
                    <i class="ph ph-arrow-left text-xl"></i>
                </button>
                <h2 class="ml-3 text-lg font-semibold text-gray-800">Settings</h2>
            </div>
            
            <div class="flex-1 p-4 overflow-y-auto">
                <div class="space-y-4">
                    <div class="bg-white rounded-lg p-4 shadow-sm border">
                        <h3 class="font-semibold text-gray-800 mb-3">Account Information</h3>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Collector ID:</span>
                                <span id="settingsCollectorId" class="font-mono">Not logged in</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Name:</span>
                                <span id="settingsCollectorName">Guest User</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Village:</span>
                                <span id="settingsVillage">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Status:</span>
                                <span id="settingsAuthStatus" class="text-orange-600">Offline Mode</span>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button id="authButton" onclick="handleAuthAction()" class="w-full bg-emerald-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-emerald-700">
                                Login
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-4 shadow-sm border">
                        <h3 class="font-semibold text-gray-800 mb-3">App Settings</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">Sync only on Wi-Fi</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="wifiOnlyInput" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                                </label>
                            </div>
                            
                            <div>
                                <label for="languageSelect" class="block text-sm font-medium text-gray-700 mb-1">Language</label>
                                <select id="languageSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                                    <option value="en">English</option>
                                    <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-4 shadow-sm border">
                        <h3 class="font-semibold text-gray-800 mb-3">Storage</h3>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Local Collections:</span>
                                <span id="storageCollectionCount">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Storage Used:</span>
                                <span id="storageUsed">0 MB</span>
                            </div>
                        </div>
                        <button onclick="clearLocalData()" class="w-full mt-3 bg-red-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-red-700">
                            Clear Local Data
                        </button>
                    </div>

                    <div class="bg-white rounded-lg p-4 shadow-sm border">
                        <h3 class="font-semibold text-gray-800 mb-3">About</h3>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>Version:</span>
                                <span>1.0.0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Type:</span>
                                <span>PWA (Offline-first)</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Backend:</span>
                                <span id="backendStatus">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex-shrink-0 p-4 border-t bg-white">
                <button onclick="showScreen('homeScreen')" class="w-full bg-emerald-600 text-white p-4 rounded-lg font-bold text-lg flex items-center justify-center shadow-lg hover:bg-emerald-700 active:bg-emerald-800">
                    <i class="ph ph-check-circle text-2xl mr-2"></i>
                    <span>Save Settings</span>
                </button>
            </div>
        </div>

        <!-- Camera Screen -->
        <div id="cameraScreen" class="app-screen bg-gray-900 overflow-hidden">
            <video id="cameraFeed" autoplay playsinline class="absolute top-0 left-0 w-full h-full object-cover"></video>

            <div class="absolute top-4 left-4 p-3 bg-black bg-opacity-50 text-white rounded-lg text-sm">
                <div id="cameraGpsDisplay" class="font-medium">üìç Getting location...</div>
                <div id="cameraTimestampDisplay" class="font-medium mt-1">üïí Getting time...</div>
            </div>

            <div class="absolute bottom-0 left-0 w-full p-6 flex justify-center items-center bg-gradient-to-t from-black via-black/70 to-transparent">
                <button onclick="takePhoto()" class="w-20 h-20 rounded-full bg-white flex items-center justify-center shadow-2xl transition-transform active:scale-110">
                    <div class="w-16 h-16 rounded-full border-4 border-gray-900 bg-white"></div>
                </button>

                <button onclick="cancelCamera()" class="absolute right-8 text-white text-sm font-medium py-2 px-4 rounded-full bg-black bg-opacity-30">
                    Cancel
                </button>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="absolute bottom-4 left-4 right-4 p-4 rounded-lg shadow-xl text-white text-center font-medium transition-all duration-300 translate-y-20 opacity-0 z-50">
        </div>

    </div>

    <!-- Hidden canvas for photo processing -->
    <canvas id="photoCanvas" class="hidden"></canvas>

    <script>
        // App State Management
        const DB_KEY = 'herbalCollectionDB';
        const SETTINGS_KEY = 'herbalAppSettings';
        
        let localDB = [];
        let appSettings = {
            syncWifiOnly: false,
            language: 'en'
        };

        let currentStream = null;
        let isAppInitialized = false;
        let permissionsGranted = {
            camera: false,
            location: false
        };

        // Enhanced Screen Management System
        class ScreenManager {
            constructor() {
                this.currentScreen = 'loadingScreen';
                this.screens = new Set(['loadingScreen', 'homeScreen', 'newCollectionScreen', 'collectionsScreen', 'settingsScreen', 'cameraScreen']);
                this.history = [];
            }

            showScreen(screenId, addToHistory = true) {
                console.log(`Transitioning from ${this.currentScreen} to ${screenId}`);
                
                if (!this.screens.has(screenId)) {
                    console.error(`Screen ${screenId} not found`);
                    return false;
                }

                try {
                    // Hide all screens
                    document.querySelectorAll('.app-screen').forEach(screen => {
                        screen.classList.remove('active');
                        screen.style.display = 'none';
                    });

                    // Show target screen
                    const targetScreen = document.getElementById(screenId);
                    if (targetScreen) {
                        targetScreen.style.display = 'flex';
                        // Use requestAnimationFrame to ensure display change takes effect
                        requestAnimationFrame(() => {
                            targetScreen.classList.add('active');
                        });
                        
                        // Add to history for navigation
                        if (addToHistory && this.currentScreen !== screenId) {
                            this.history.push(this.currentScreen);
                        }
                        
                        this.currentScreen = screenId;
                        this.onScreenChanged(screenId);
                        return true;
                    }
                } catch (error) {
                    console.error('Error switching screens:', error);
                    return false;
                }
                return false;
            }

            goBack() {
                if (this.history.length > 0) {
                    const previousScreen = this.history.pop();
                    this.showScreen(previousScreen, false);
                } else {
                    this.showScreen('homeScreen', false);
                }
            }

            onScreenChanged(screenId) {
                // Handle screen-specific initialization
                switch(screenId) {
                    case 'collectionsScreen':
                        renderCollections();
                        break;
                    case 'homeScreen':
                        updateSyncStatusFooter();
                        break;
                    case 'cameraScreen':
                        // Camera initialization handled separately
                        break;
                }
            }
        }

        // Create global screen manager instance
        const screenManager = new ScreenManager();

        // API Configuration
        const API_CONFIG = {
            baseURL: 'http://localhost:3000/api/v1',
            timeout: 30000,
            headers: {
                'Content-Type': 'application/json'
            }
        };

        // API Helper Functions
        const apiCall = async (endpoint, options = {}) => {
            const token = localStorage.getItem('authToken');
            const config = {
                method: 'GET',
                headers: {
                    ...API_CONFIG.headers,
                    ...(token && { 'Authorization': `Bearer ${token}` })
                },
                ...options
            };

            try {
                const response = await fetch(`${API_CONFIG.baseURL}${endpoint}`, config);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'API request failed');
                }
                
                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        };

        // Auth API Functions
        const authAPI = {
            async login(userId, password) {
                return apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ userId, password })
                });
            },

            async register(userData) {
                return apiCall('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });
            },

            async verifyToken() {
                return apiCall('/auth/verify');
            }
        };

        // Collections API Functions
        const collectionsAPI = {
            async uploadCollection(collectionData, photoFile) {
                const token = localStorage.getItem('authToken');
                const formData = new FormData();
                
                // Add collection data to form
                Object.keys(collectionData).forEach(key => {
                    if (key !== 'photo') {
                        formData.append(key, collectionData[key]);
                    }
                });
                
                // Add photo file
                if (photoFile) {
                    formData.append('photo', photoFile);
                }

                const response = await fetch(`${API_CONFIG.baseURL}/collections`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'Upload failed');
                }

                return data;
            },

            async getCollections(page = 1, limit = 20) {
                return apiCall(`/collections?page=${page}&limit=${limit}`);
            },

            async getStats() {
                return apiCall('/collections/stats/summary');
            }
        };

        // Sync API Functions
        const syncAPI = {
            async bulkSync(collections) {
                return apiCall('/sync/bulk', {
                    method: 'POST',
                    body: JSON.stringify({ collections })
                });
            },

            async getSyncStatus() {
                return apiCall('/sync/status');
            },

            async getSyncReport() {
                return apiCall('/sync/report');
            }
        };

        // Permission Management System
        class PermissionManager {
            constructor() {
                this.permissions = {
                    camera: { granted: false, requested: false },
                    geolocation: { granted: false, requested: false }
                };
            }

            async requestAllPermissions() {
                console.log('Requesting all required permissions...');
                
                try {
                    const results = await Promise.allSettled([
                        this.requestCameraPermission(),
                        this.requestLocationPermission()
                    ]);

                    const cameraResult = results[0];
                    const locationResult = results[1];

                    console.log('Permission results:', {
                        camera: cameraResult.status,
                        location: locationResult.status
                    });

                    return {
                        camera: cameraResult.status === 'fulfilled' && cameraResult.value,
                        location: locationResult.status === 'fulfilled' && locationResult.value
                    };
                } catch (error) {
                    console.error('Error requesting permissions:', error);
                    return { camera: false, location: false };
                }
            }

            async requestCameraPermission() {
                if (this.permissions.camera.granted) {
                    return true;
                }

                this.permissions.camera.requested = true;

                try {
                    // Check if MediaDevices API is supported
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        throw new Error('Camera not supported on this device');
                    }

                    // Request camera permission by attempting to get media stream
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    
                    // Stop the stream immediately - we just needed permission
                    stream.getTracks().forEach(track => track.stop());
                    
                    this.permissions.camera.granted = true;
                    console.log('Camera permission granted');
                    return true;

                } catch (error) {
                    console.error('Camera permission denied:', error);
                    this.permissions.camera.granted = false;
                    
                    let message = 'Camera access denied. ';
                    switch(error.name) {
                        case 'NotAllowedError':
                            message += 'Please enable camera permission in your browser settings.';
                            break;
                        case 'NotFoundError':
                            message += 'No camera found on this device.';
                            break;
                        case 'NotSupportedError':
                            message += 'Camera not supported on this device.';
                            break;
                        default:
                            message += error.message;
                    }
                    
                    showToast(message, true);
                    return false;
                }
            }

            async requestLocationPermission() {
                if (this.permissions.geolocation.granted) {
                    return true;
                }

                this.permissions.geolocation.requested = true;

                return new Promise((resolve) => {
                    if (!navigator.geolocation) {
                        console.error('Geolocation not supported');
                        showToast('Location services not supported on this device.', true);
                        resolve(false);
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            console.log('Location permission granted');
                            this.permissions.geolocation.granted = true;
                            resolve(true);
                        },
                        (error) => {
                            console.error('Location permission denied:', error);
                            this.permissions.geolocation.granted = false;
                            
                            let message = 'Location access denied. ';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    message += 'Please enable location permission in your browser settings.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    message += 'Location information unavailable.';
                                    break;
                                case error.TIMEOUT:
                                    message += 'Location request timed out.';
                                    break;
                                default:
                                    message += error.message;
                            }
                            
                            showToast(message, true);
                            resolve(false);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                    );
                });
            }

            async checkPermissionStatus() {
                try {
                    // Check camera permission
                    if (navigator.permissions) {
                        const cameraPermission = await navigator.permissions.query({ name: 'camera' });
                        this.permissions.camera.granted = cameraPermission.state === 'granted';
                        
                        const locationPermission = await navigator.permissions.query({ name: 'geolocation' });
                        this.permissions.geolocation.granted = locationPermission.state === 'granted';
                    }
                } catch (error) {
                    console.log('Permission API not fully supported, will check on demand');
                }
                
                return {
                    camera: this.permissions.camera.granted,
                    location: this.permissions.geolocation.granted
                };
            }

            showPermissionPrompt() {
                return new Promise((resolve) => {
                    const promptHTML = `
                        <div id="permissionModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                            <div class="bg-white rounded-xl max-w-md w-full p-6 text-center">
                                <i class="ph-fill ph-shield-check text-6xl text-emerald-600 mb-4"></i>
                                <h2 class="text-2xl font-bold text-gray-800 mb-3">Permissions Required</h2>
                                <p class="text-gray-600 mb-6">This app needs access to:</p>
                                
                                <div class="space-y-3 text-left mb-6">
                                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                        <i class="ph-fill ph-camera text-xl text-blue-600"></i>
                                        <div>
                                            <div class="font-medium">Camera</div>
                                            <div class="text-sm text-gray-600">Take photos of herb collections</div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                        <i class="ph-fill ph-map-pin text-xl text-red-600"></i>
                                        <div>
                                            <div class="font-medium">Location</div>
                                            <div class="text-sm text-gray-600">Record GPS coordinates for traceability</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex gap-3">
                                    <button onclick="handlePermissionResponse(false)" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-medium">
                                        Later
                                    </button>
                                    <button onclick="handlePermissionResponse(true)" class="flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg font-medium">
                                        Allow Access
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', promptHTML);
                    
                    window.handlePermissionResponse = (allow) => {
                        document.getElementById('permissionModal').remove();
                        delete window.handlePermissionResponse;
                        resolve(allow);
                    };
                });
            }
        }

        // Create global permission manager
        const permissionManager = new PermissionManager();

        // Global navigation function (used by onclick handlers)
        function showScreen(screenId) {
            return screenManager.showScreen(screenId);
        }

        // Utility Functions
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // API Functions
        async function apiRequest(endpoint, options = {}) {
            const url = `${API_CONFIG.baseURL}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };

            try {
                const response = await fetch(url, config);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API request failed for ${endpoint}:`, error);
                
                // Check if it's a network error (offline)
                if (!navigator.onLine) {
                    throw new Error('OFFLINE');
                }
                
                throw error;
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'absolute bottom-4 left-4 right-4 p-4 rounded-lg shadow-xl text-white text-center font-medium transition-all duration-300 z-50';
            
            toast.classList.add(isError ? 'bg-red-600' : 'bg-gray-900');
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Database Functions
        function loadDB() {
            localDB = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        }

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(localDB));
            updateSyncStatusFooter();
        }

        function loadSettings() {
            const storedSettings = localStorage.getItem(SETTINGS_KEY);
            if (storedSettings) {
                appSettings = JSON.parse(storedSettings);
                document.getElementById('wifiOnlyInput').checked = appSettings.syncWifiOnly || false;
                document.getElementById('languageSelect').value = appSettings.language || 'en';
            }
        }

        function saveSettings() {
            appSettings.syncWifiOnly = document.getElementById('wifiOnlyInput').checked;
            appSettings.language = document.getElementById('languageSelect').value;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
            showToast('Settings saved successfully!');
            showScreen('homeScreen');
        }

        function updateSyncStatusFooter() {
            const pendingCount = localDB.filter(item => item.status === 'pending').length;
            const footer = document.getElementById('syncStatusFooter');
            if (footer) {
                if (pendingCount > 0) {
                    footer.innerHTML = `üü° <span class="font-medium">${pendingCount} record(s) pending sync</span>`;
                } else {
                    footer.innerHTML = `üü¢ All records synced`;
                }
            }
        }

        // Collection Functions
        function initNewCollection() {
            // Reset form
            document.getElementById('speciesInput').value = '';
            document.getElementById('weatherInput').value = '';
            document.getElementById('photoBase64Input').value = '';
            document.getElementById('photoPreview').classList.add('hidden');
            document.getElementById('photoPreview').src = '';
            document.getElementById('gpsInput').value = '';
            document.getElementById('timestampInput').value = '';
            
            showScreen('newCollectionScreen');
        }



        function stopCameraFeed() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function cancelCamera() {
            stopCameraFeed();
            screenManager.showScreen('newCollectionScreen');
        }

        function takePhoto() {
            try {
                const video = document.getElementById('cameraFeed');
                const canvas = document.getElementById('photoCanvas');
                const context = canvas.getContext('2d');

                // Ensure video is playing
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    showToast('Please wait for camera to load completely.', true);
                    return;
                }

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                // Draw the video frame to canvas
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Convert to base64 with compression
                const base64Data = canvas.toDataURL('image/jpeg', 0.7);

                stopCameraFeed();

                // Populate form with captured data
                document.getElementById('photoBase64Input').value = base64Data;
                document.getElementById('photoPreview').src = base64Data;
                document.getElementById('photoPreview').classList.remove('hidden');

                // Get GPS and timestamp from camera screen
                const cameraGpsText = document.getElementById('cameraGpsDisplay').textContent.replace('üìç ', '');
                const cameraTimeText = document.getElementById('cameraTimestampDisplay').textContent.replace('üïí ', '');
                
                document.getElementById('gpsInput').value = cameraGpsText;
                document.getElementById('timestampInput').value = cameraTimeText;

                showToast('Photo captured successfully!');
                screenManager.showScreen('newCollectionScreen');
                
            } catch (error) {
                console.error('Error taking photo:', error);
                showToast('Error capturing photo. Please try again.', true);
            }
        }

        function saveCollection() {
            try {
                // Validation
                const species = document.getElementById('speciesInput').value;
                if (!species) {
                    showToast('Please select a herb name.', true);
                    return;
                }
                
                const base64Photo = document.getElementById('photoBase64Input').value;
                if (!base64Photo) {
                    showToast('Please take a photo first.', true);
                    return;
                }
                
                const gpsValue = document.getElementById('gpsInput').value;
                if (!gpsValue || gpsValue === 'Getting location...' || gpsValue === 'Location unavailable') {
                    showToast('Please wait for GPS location or try taking photo again.', true);
                    return;
                }
                
                const timestamp = document.getElementById('timestampInput').value;
                if (!timestamp) {
                    showToast('Please take a photo to capture timestamp.', true);
                    return;
                }

                const gpsCoords = gpsValue.split(',');
                
                const collection = {
                    id: generateUUID(),
                    species: species,
                    weather: document.getElementById('weatherInput').value || "Not specified",
                    timestamp: timestamp,
                    location: {
                        latitude: gpsCoords[0] ? gpsCoords[0].trim() : "N/A",
                        longitude: gpsCoords[1] ? gpsCoords[1].trim() : "N/A"
                    },
                    photo: base64Photo,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };

                localDB.unshift(collection);
                saveDB();

                showToast('Collection saved locally!');
                
                // Clear form after successful save
                document.getElementById('speciesInput').value = '';
                document.getElementById('weatherInput').value = '';
                document.getElementById('photoBase64Input').value = '';
                document.getElementById('photoPreview').classList.add('hidden');
                document.getElementById('gpsInput').value = '';
                document.getElementById('timestampInput').value = '';
                
                screenManager.showScreen('homeScreen');
                
            } catch (error) {
                console.error('Error saving collection:', error);
                showToast('Error saving collection. Please try again.', true);
            }
        }

        function renderCollections() {
            const container = document.getElementById('collectionListContainer');
            
            if (localDB.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No collections yet. Start by creating your first collection!</p>';
                return;
            }
            
            container.innerHTML = localDB.map(item => {
                const isPending = item.status === 'pending';
                const statusClass = isPending ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                const statusText = isPending ? 'Pending' : 'Synced';
                
                return `
                <div class="flex items-center p-4 border-b hover:bg-gray-50 cursor-pointer" onclick="showCollectionDetail('${item.id}')">
                    <div class="p-3 bg-emerald-100 text-emerald-700 rounded-full">
                        <i class="ph-fill ph-plant text-2xl"></i>
                    </div>
                    <div class="flex-1 ml-4">
                        <p class="font-bold text-lg text-gray-800">${item.species}</p>
                        <p class="text-sm text-gray-500">${new Date(item.timestamp).toLocaleString()}</p>
                    </div>
                    <span class="flex-shrink-0 rounded-full px-3 py-1 text-xs font-medium ${statusClass}">
                        ${statusText}
                    </span>
                </div>
                `;
            }).join('');
        }

        function showCollectionDetail(id) {
            const item = localDB.find(i => i.id === id);
            if (!item) return;

            const details = [
                `Species: ${item.species}`,
                `Weather: ${item.weather}`,
                `Location: ${item.location.latitude}, ${item.location.longitude}`,
                `Time: ${item.timestamp}`,
                `Status: ${item.status}`,
                `Created: ${new Date(item.createdAt).toLocaleString()}`
            ].join('\n');

            alert(`Collection Details:\n\n${details}`);
        }

        async function triggerSync() {
            const pendingRecords = localDB.filter(item => item.status === 'pending');
            
            if (pendingRecords.length === 0) {
                showToast('No pending records to sync.');
                return;
            }
            
            // Check if user is authenticated
            const token = localStorage.getItem('authToken');
            if (!token) {
                showToast('Please login to sync your collections.', true);
                return;
            }
            
            showToast(`Syncing ${pendingRecords.length} record(s)...`);
            
            try {
                // Prepare collections for bulk sync
                const collectionsToSync = pendingRecords.map(item => ({
                    id: item.id,
                    species: item.species,
                    weather: item.weather,
                    timestamp: item.timestamp,
                    latitude: parseFloat(item.location.latitude),
                    longitude: parseFloat(item.location.longitude),
                    base64Photo: item.photo
                }));

                // Call the bulk sync API
                const response = await syncAPI.bulkSync(collectionsToSync);
                
                // Update local status based on API response
                if (response.summary.successful > 0) {
                    for (const item of localDB) {
                        if (item.status === 'pending') {
                            const wasSynced = response.results.successful.find(s => s.id === item.id);
                            if (wasSynced) {
                                item.status = 'synced';
                                item.syncedAt = new Date().toISOString();
                            }
                        }
                    }
                    saveDB();
                }

                // Show appropriate message
                if (response.summary.failed === 0) {
                    showToast(`Successfully synced all ${response.summary.successful} record(s)!`);
                } else {
                    showToast(`Synced ${response.summary.successful} records, ${response.summary.failed} failed.`, true);
                }

            } catch (error) {
                console.error('Sync error:', error);
                showToast(`Sync failed: ${error.message}`, true);
            }
        }

        // Authentication Functions
        async function handleLogin(event) {
            event.preventDefault();
            
            const userId = document.getElementById('loginUserId').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!userId || !password) {
                showToast('Please fill in all fields', true);
                return;
            }
            
            try {
                showToast('Logging in...');
                const response = await authAPI.login(userId, password);
                
                // Store auth token and user data
                localStorage.setItem('authToken', response.token);
                localStorage.setItem('userData', JSON.stringify(response.user));
                
                showToast('Login successful!');
                updateAuthUI(response.user);
                screenManager.showScreen('homeScreen');
                
            } catch (error) {
                console.error('Login error:', error);
                showToast(`Login failed: ${error.message}`, true);
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            
            const userData = {
                userId: document.getElementById('registerUserId').value,
                name: document.getElementById('registerName').value,
                phone: document.getElementById('registerPhone').value,
                village: document.getElementById('registerVillage').value,
                district: document.getElementById('registerDistrict').value,
                state: document.getElementById('registerState').value,
                password: document.getElementById('registerPassword').value
            };
            
            // Validate required fields
            for (const [key, value] of Object.entries(userData)) {
                if (!value) {
                    showToast(`Please fill in ${key.replace(/([A-Z])/g, ' $1').toLowerCase()}`, true);
                    return;
                }
            }
            
            try {
                showToast('Creating account...');
                const response = await authAPI.register(userData);
                
                // Store auth token and user data
                localStorage.setItem('authToken', response.token);
                localStorage.setItem('userData', JSON.stringify(response.user));
                
                showToast('Registration successful!');
                updateAuthUI(response.user);
                screenManager.showScreen('homeScreen');
                
            } catch (error) {
                console.error('Registration error:', error);
                showToast(`Registration failed: ${error.message}`, true);
            }
        }

        function updateAuthUI(user) {
            if (user) {
                // Update settings screen
                document.getElementById('settingsCollectorId').textContent = user.userId;
                document.getElementById('settingsCollectorName').textContent = user.name;
                document.getElementById('settingsVillage').textContent = user.village + ', ' + user.district;
                document.getElementById('settingsAuthStatus').textContent = 'Logged in';
                document.getElementById('settingsAuthStatus').className = 'text-green-600';
                document.getElementById('authButton').textContent = 'Logout';
                document.getElementById('authButton').onclick = handleLogout;
            } else {
                // Reset to guest mode
                document.getElementById('settingsCollectorId').textContent = 'Not logged in';
                document.getElementById('settingsCollectorName').textContent = 'Guest User';
                document.getElementById('settingsVillage').textContent = '-';
                document.getElementById('settingsAuthStatus').textContent = 'Offline Mode';
                document.getElementById('settingsAuthStatus').className = 'text-orange-600';
                document.getElementById('authButton').textContent = 'Login';
                document.getElementById('authButton').onclick = handleAuthAction;
            }
        }

        function handleAuthAction() {
            screenManager.showScreen('loginScreen');
        }

        function handleLogout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            updateAuthUI(null);
            showToast('Logged out successfully');
        }

        function continueWithoutAuth() {
            screenManager.showScreen('homeScreen');
            showToast('Using offline mode. Login later to sync data.');
        }

        async function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');
            
            if (token && userData) {
                try {
                    // Verify token is still valid
                    await authAPI.verifyToken();
                    const user = JSON.parse(userData);
                    updateAuthUI(user);
                    return true;
                } catch (error) {
                    console.log('Token expired or invalid, clearing auth data');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userData');
                }
            }
            
            return false;
        }

        async function checkBackendStatus() {
            try {
                const response = await fetch(`${API_CONFIG.baseURL.replace('/api/v1', '')}/health`);
                if (response.ok) {
                    document.getElementById('backendStatus').textContent = 'Connected';
                    document.getElementById('backendStatus').className = 'text-green-600';
                } else {
                    document.getElementById('backendStatus').textContent = 'Error';
                    document.getElementById('backendStatus').className = 'text-red-600';
                }
            } catch (error) {
                document.getElementById('backendStatus').textContent = 'Offline';
                document.getElementById('backendStatus').className = 'text-red-600';
            }
        }

        function clearLocalData() {
            if (confirm('Are you sure you want to clear all local data? This cannot be undone.')) {
                localStorage.clear();
                localDB = [];
                saveDB();
                updateSyncStatusFooter();
                showToast('Local data cleared');
                updateAuthUI(null);
                location.reload();
            }
        }

        // Enhanced App Initialization with Authentication
        async function initApp() {
            console.log('Initializing Herbal Harvester app...');
            
            try {
                // Load data and settings
                loadDB();
                loadSettings();
                updateSyncStatusFooter();
                
                // Set up event handlers
                setupEventHandlers();
                
                // Initialize phosphor icons
                if (globalThis.ph !== undefined) {
                    console.log('Phosphor icons loaded successfully');
                } else {
                    console.warn('Phosphor icons not loaded properly');
                }
                
                // Show loading screen initially
                screenManager.showScreen('loadingScreen', false);
                
                // Check existing permissions
                await permissionManager.checkPermissionStatus();
                
                // Check backend status
                checkBackendStatus();
                
                // Auto-transition after loading
                setTimeout(async () => {
                    console.log('Loading complete, checking auth and permissions...');
                    
                    // Check authentication status
                    const isAuthenticated = await checkAuthStatus();
                    
                    if (!isAuthenticated) {
                        // Show login screen for first time users
                        screenManager.showScreen('loginScreen');
                        return;
                    }
                    
                    // Check if we need to request permissions
                    const shouldPrompt = await permissionManager.showPermissionPrompt();
                    
                    if (shouldPrompt) {
                        console.log('User agreed to permission requests');
                        const permissions = await permissionManager.requestAllPermissions();
                        
                        if (permissions.camera && permissions.location) {
                            showToast('All permissions granted! Ready to collect herbs.');
                        } else {
                            showToast('Some permissions denied. App functionality may be limited.', true);
                        }
                    }
                    
                    screenManager.showScreen('homeScreen');
                    isAppInitialized = true;
                }, 2000);
                
            } catch (error) {
                console.error('Error during app initialization:', error);
                showToast('Error initializing app. Please refresh.', true);
            }
        }

        // Setup Event Handlers
        function setupEventHandlers() {
            // Authentication form handlers
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            if (registerForm) {
                registerForm.addEventListener('submit', handleRegister);
            }
            
            // Back button handling for Android
            document.addEventListener('backbutton', function(e) {
                e.preventDefault();
                if (screenManager.currentScreen === 'homeScreen') {
                    // Exit app or show confirmation
                    if (confirm('Do you want to exit the app?')) {
                        navigator.app.exitApp();
                    }
                } else {
                    screenManager.goBack();
                }
            }, false);
            
            // Handle settings save button properly
            const saveSettingsBtn = document.querySelector('#settingsScreen button[onclick="showScreen(\'homeScreen\')"]');
            if (saveSettingsBtn) {
                saveSettingsBtn.onclick = function() {
                    saveSettings();
                };
            }
            
            // Enhanced error handling for camera
            window.addEventListener('error', function(e) {
                console.error('Global error:', e.error);
                if (e.error && e.error.name === 'NotAllowedError') {
                    showToast('Camera permission denied. Please enable camera access.', true);
                }
            });
        }

        // Enhanced Camera Functions with Permission Checking
        async function startCamera() {
            console.log('Starting camera...');
            
            // Check camera permission first
            if (!permissionManager.permissions.camera.granted) {
                console.log('Camera permission not granted, requesting...');
                const granted = await permissionManager.requestCameraPermission();
                if (!granted) {
                    return;
                }
            }
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showToast('Camera not supported on this device.', true);
                return;
            }

            try {
                screenManager.showScreen('cameraScreen');
                fetchAndDisplayCameraMetadata();

                const video = document.getElementById('cameraFeed');
                
                // Request camera with fallback options
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                video.onloadedmetadata = () => {
                    video.play().catch(e => {
                        console.error('Video play error:', e);
                        showToast('Error starting camera preview.', true);
                    });
                };

            } catch (err) {
                console.error('Camera Error:', err);
                
                const errorMessages = {
                    'NotAllowedError': 'Camera permission denied. Please enable camera access.',
                    'NotFoundError': 'No camera found on this device.',
                    'NotSupportedError': 'Camera not supported on this device.'
                };
                
                const errorMessage = errorMessages[err.name] || `Camera error: ${err.message}`;
                showToast(errorMessage, true);
                screenManager.showScreen('newCollectionScreen');
            }
        }

        // Enhanced GPS and Timestamp fetching with permission checking
        async function fetchAndDisplayCameraMetadata() {
            const gpsEl = document.getElementById('cameraGpsDisplay');
            const timeEl = document.getElementById('cameraTimestampDisplay');

            // Set timestamp immediately
            const now = new Date();
            const localTimeString = now.toLocaleString('en-IN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            timeEl.textContent = `üïí ${localTimeString}`;
            timeEl.dataset.isoValue = now.toISOString();

            // Fetch GPS location with permission checking
            gpsEl.textContent = 'üìç Getting location...';
            
            // Check if location permission is granted
            if (!permissionManager.permissions.location.granted) {
                gpsEl.textContent = 'üìç Location permission needed';
                return;
            }
            
            if ('geolocation' in navigator) {
                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 60000
                };
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude, accuracy } = position.coords;
                        const gpsString = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                        gpsEl.textContent = `üìç ${gpsString}`;
                        gpsEl.dataset.latitude = latitude;
                        gpsEl.dataset.longitude = longitude;
                        gpsEl.dataset.accuracy = accuracy;
                        console.log(`GPS accuracy: ${accuracy} meters`);
                    },
                    (error) => {
                        console.error('GPS Error:', error);
                        const errorMessages = {
                            [error.PERMISSION_DENIED]: 'Location permission denied',
                            [error.POSITION_UNAVAILABLE]: 'Location unavailable',
                            [error.TIMEOUT]: 'Location timeout'
                        };
                        const errorMsg = errorMessages[error.code] || 'Location unavailable';
                        gpsEl.textContent = `üìç ${errorMsg}`;
                    },
                    options
                );
            } else {
                gpsEl.textContent = 'üìç GPS not supported';
            }
        }

        // Start the app when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            // DOM already loaded
            initApp();
        }

        // Additional initialization for Capacitor/Cordova
        document.addEventListener('deviceready', function() {
            console.log('Device is ready');
            if (!isAppInitialized) {
                initApp();
            }
        }, false);
    </script>
</body>
</html>